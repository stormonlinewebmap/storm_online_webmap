<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

<title>الخريطة التفاعلية لشبكات السيول</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  overflow: hidden;
  font-family: Arial, sans-serif;
  direction: rtl;
  background: #f3f4f6;
}

/* العنوان */
#header {
  background: rgb(36,109,37);
  color: white;
  text-align: center;
  padding: 14px;
  font-size: 20px;
}

/* تسجيل الدخول */
#loginOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10000;
}

#loginBox {
  background: white;
  padding: 22px;
  border-radius: 10px;
  width: 90%;
  max-width: 340px;
  text-align: center;
}

#loginBox input,
#loginBox button {
  width: 100%;
  padding: 12px;
  margin-top: 12px;
  font-size: 16px;
}

#loginBox button {
  background: rgb(36,109,37);
  color: white;
  border: none;
  border-radius: 6px;
}

#errorMsg {
  color: #b91c1c;
  margin-top: 10px;
}

/* الخريطة */
#map-container {
  position: fixed;
  inset: 0;
  top: 52px; /* ارتفاع العنوان */
  visibility: hidden;
  background: white;
}

#map-container.active {
  visibility: visible;
}

iframe {
  width: 100%;
  height: 100%;
  border: none;
}
</style>
</head>

<body>

<div id="header">إدارة تصميم ودراسة شبكات السيول</div>

<div id="loginOverlay">
  <div id="loginBox">
    <h3>تسجيل الدخول</h3>
    <input id="username" placeholder="اسم المستخدم">
    <input id="password" type="password" placeholder="كلمة المرور">
    <button onclick="checkLogin()">دخول</button>
    <div id="errorMsg"></div>
  </div>
</div>

<div id="map-container">
  <iframe id="mapFrame"></iframe>
</div>

<script>
const USERS = [
  { username: "admin", password: "123" },
  { username: "user1", password: "111" },
  { username: "user2", password: "222" },
  { username: "user3", password: "333" }
];

let mapLoaded = false;

function showMap() {
  const map = document.getElementById("map-container");
  const iframe = document.getElementById("mapFrame");

  map.classList.add("active");

  if (!mapLoaded) {
    iframe.src =
      "https://www.arcgis.com/apps/mapviewer/index.html?webmap=c547b98159744cacb7a42db1c060bf64";
    mapLoaded = true;
  }
}

function checkLogin() {
  const u = username.value.trim();
  const p = password.value.trim();
  const err = errorMsg;

  const valid = USERS.find(x => x.username === u && x.password === p);
  if (!valid) {
    err.textContent = "بيانات الدخول غير صحيحة";
    return;
  }

  navigator.geolocation.getCurrentPosition(
    pos => {
      fetch("https://api.ipify.org?format=json")
        .then(r => r.json())
        .then(d => sendToGoogle(u, d.ip, pos.coords.latitude, pos.coords.longitude))
        .catch(() => sendToGoogle(u, "unknown", pos.coords.latitude, pos.coords.longitude));

      document.getElementById("loginOverlay").style.display = "none";
      showMap();
    },
    () => {
      err.textContent = "يجب السماح بتحديد الموقع";
    },
    {
      enableHighAccuracy: true,
      timeout: 10000
    }
  );
}

function sendToGoogle(user, ip, lat, lon) {
  fetch("https://script.google.com/macros/s/AKfycbxdgRaxLQxrDkP_--wuX_H9RueEnKkTYhDhy-O_QgJDZQPpXmOANOZhbGjN8lNrqYtY/exec", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body:
      `user=${encodeURIComponent(user)}&ip=${encodeURIComponent(ip)}&lat=${lat}&lon=${lon}`
  }).catch(()=>{});
}
</script>

</body>
</html>
