<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

<title>الخريطة التفاعلية لشبكات السيول</title>

<style>
:root {
  --vh: 100vh;
}

body {
  margin: 0;
  font-family: Arial, sans-serif;
  direction: rtl;
  background: #f3f4f6;
  height: 100%;
  overflow: hidden;
}

#header {
  background: rgb(36, 109, 37);
  color: white;
  padding: 14px;
  font-size: 20px;
  text-align: center;
}

#loginOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.55);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

#loginBox {
  background: #fff;
  padding: 22px;
  border-radius: 10px;
  width: 100%;
  max-width: 340px;
  text-align: center;
}

#loginBox input,
#loginBox button {
  width: 100%;
  padding: 12px;
  margin-top: 12px;
  font-size: 16px;
}

#loginBox button {
  background: rgb(36,109,37);
  color: white;
  border: none;
  border-radius: 6px;
}

#errorMsg {
  color: #b91c1c;
  margin-top: 10px;
}

/* الخريطة */
#map-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: calc(var(--vh));
  display: none;
  background: white;
}

iframe {
  width: 100%;
  height: 100%;
  border: none;
  display: block;
}
</style>
</head>

<body>

<div id="header">إدارة تصميم ودراسة شبكات السيول</div>

<div id="loginOverlay">
  <div id="loginBox">
    <h3>تسجيل الدخول</h3>
    <input id="username" placeholder="اسم المستخدم">
    <input id="password" type="password" placeholder="كلمة المرور">
    <button onclick="checkLogin()">دخول</button>
    <div id="errorMsg"></div>
  </div>
</div>

<div id="map-container">
  <iframe id="mapFrame"
    src="https://www.arcgis.com/apps/mapviewer/index.html?webmap=c547b98159744cacb7a42db1c060bf64">
  </iframe>
</div>

<script>
const USERS = [
  { username: "admin", password: "123" },
  { username: "user1", password: "111" },
  { username: "user2", password: "222" },
  { username: "user3", password: "333" }
];

// إصلاح vh في Safari
function setVH() {
  const vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh * 100}px`);
}

function showMap() {
  document.getElementById('loginOverlay').style.display = 'none';
  const map = document.getElementById('map-container');
  map.style.display = 'block';

  setVH();

  // إجبار Safari على إعادة رسم iframe
  const iframe = document.getElementById('mapFrame');
  iframe.style.display = 'none';
  iframe.offsetHeight;
  iframe.style.display = 'block';
}

function checkLogin() {
  const u = username.value.trim();
  const p = password.value.trim();
  const err = errorMsg;

  const ok = USERS.find(x => x.username === u && x.password === p);
  if (!ok) {
    err.textContent = "بيانات الدخول غير صحيحة";
    return;
  }

  navigator.geolocation.getCurrentPosition(
    pos => {
      fetch("https://api.ipify.org?format=json")
        .then(r => r.json())
        .then(d => sendToGoogle(u, d.ip, pos.coords.latitude, pos.coords.longitude))
        .catch(() => sendToGoogle(u, "unknown", pos.coords.latitude, pos.coords.longitude));

      showMap();
    },
    () => err.textContent = "يجب السماح بتحديد الموقع"
  );
}

function sendToGoogle(user, ip, lat, lon) {
  fetch("https://script.google.com/macros/s/AKfycbxdgRaxLQxrDkP_--wuX_H9RueEnKkTYhDhy-O_QgJDZQPpXmOANOZhbGjN8lNrqYtY/exec", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body:
      `user=${encodeURIComponent(user)}&ip=${ip}&lat=${lat}&lon=${lon}`
  });
}

window.addEventListener('load', setVH);
window.addEventListener('resize', setVH);
window.addEventListener('orientationchange', () => setTimeout(setVH, 300));
</script>

</body>
</html>
